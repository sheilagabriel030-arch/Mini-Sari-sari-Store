<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-thumb {
            width: 60px !important;
            height: 60px !important;
            object-fit: cover !important;
            border-radius: 6px !important;
            border: 2px solid #dee2e6 !important;
        }
        
        .no-image {
            width: 60px !important;
            height: 60px !important;
            background-color: #f8f9fa !important;
            border: 2px dashed #dee2e6 !important;
            border-radius: 6px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            color: #6c757d !important;
        }
        
        .quantity-input {
            width: 50px !important;
            text-align: center !important;
        }
        
        .table th {
            background-color: #2c3e50 !important;
            color: white !important;
            border: 1px solid #dee2e6;
        }
        
        .table td {
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .cart-section {
            min-width: 180px;
        }
        
        .pagination-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .page-info {
            color: white;
            font-weight: 600;
        }
        
        .product-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .product-description {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">üè™ Mini Sari-Sari Store</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/products">Products</a>
                <a class="nav-link" href="/cart">Cart üõí</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-primary">üì¶ Products</h1>
            <div>
                <a href="/cart" class="btn btn-warning btn-lg">
                    üõí View Cart
                </a>
            </div>
        </div>

        <!-- Products Table -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 80px;">Image</th>
                        <th>Product Details</th>
                        <th style="width: 120px;">Category</th>
                        <th style="width: 100px;">Price</th>
                        <th style="width: 100px;">Stock</th>
                        <th style="width: 200px;" class="cart-section">Add to Cart</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (products.length === 0) { %>
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <h5>No products available</h5>
                                <p>Please check back later.</p>
                            </div>
                        </td>
                    </tr>
                    <% } else { %>
                        <% products.forEach(product => { %>
                        <tr>
                            <td class="text-center">
                                <% if (product.image_url) { %>
                                    <img src="<%= product.image_url %>" alt="<%= product.name %>" 
                                         class="product-thumb">
                                <% } else { %>
                                    <div class="no-image">
                                        üì¶<br>
                                        <small>No Image</small>
                                    </div>
                                <% } %>
                            </td>
                            <td>
                                <div class="product-name"><%= product.name %></div>
                                <% if (product.description) { %>
                                    <div class="product-description"><%= product.description %></div>
                                <% } %>
                            </td>
                            <td>
                                <span class="badge bg-secondary"><%= product.category %></span>
                            </td>
                            <td>
                                <strong class="text-success">‚Ç±<%= parseFloat(product.price).toFixed(2) %></strong>
                            </td>
                            <td class="text-center">
                                <span class="badge <%= product.stock_quantity < 10 ? 'bg-danger' : 'bg-success' %>">
                                    <%= product.stock_quantity %>
                                </span>
                            </td>
                            <td class="cart-section">
                                <% if (product.stock_quantity > 0) { %>
                                <div class="d-flex flex-column gap-1">
                                    <div class="d-flex justify-content-center align-items-center gap-1">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                style="width: 30px; height: 30px; padding: 0;"
                                                type="button"
                                                onclick="decreaseQuantity(<%= product.id %>)">-</button>
                                        <input type="number" 
                                               class="form-control form-control-sm quantity-input text-center" 
                                               id="quantity-<%= product.id %>" 
                                               value="1" 
                                               min="1" 
                                               max="<%= product.stock_quantity %>">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                style="width: 30px; height: 30px; padding: 0;"
                                                type="button"
                                                onclick="increaseQuantity(<%= product.id %>)">+</button>
                                    </div>
                                    <button class="btn btn-sm btn-success w-100" 
                                            type="button"
                                            onclick="addToCart(<%= product.id %>)">
                                        üõí Add to Cart
                                    </button>
                                </div>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark">Out of Stock</span>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination Section -->
        <% if (totalPages > 1) { %>
        <div class="pagination-section">
            <div class="row align-items-center">
                <div class="col-md-4 text-center text-md-start">
                    <span class="page-info">
                        üìÑ Page <%= currentPage %> of <%= totalPages %> 
                        | üì¶ Total Products: <%= totalProducts %>
                    </span>
                </div>
                <div class="col-md-4 text-center">
                    <div class="btn-group" role="group">
                        <% if (hasPrevPage) { %>
                            <a href="/products?page=<%= currentPage - 1 %>" class="btn btn-light">
                                ‚Üê Previous
                            </a>
                        <% } %>
                        
                        <!-- Page numbers -->
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <% if (i === currentPage) { %>
                                <span class="btn btn-primary"><%= i %></span>
                            <% } else { %>
                                <a href="/products?page=<%= i %>" class="btn btn-light"><%= i %></a>
                            <% } %>
                        <% } %>
                        
                        <% if (hasNextPage) { %>
                            <a href="/products?page=<%= currentPage + 1 %>" class="btn btn-light">
                                Next ‚Üí
                            </a>
                        <% } %>
                    </div>
                </div>
                <div class="col-md-4 text-center text-md-end">
                    <a href="/products?page=1" class="btn btn-light">
                        üè† First Page
                    </a>
                </div>
            </div>
        </div>
        <% } %>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p>&copy; 2025 Mini Sari-Sari Store. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Quantity control functions
        function increaseQuantity(productId) {
            const input = document.getElementById('quantity-' + productId);
            const max = parseInt(input.max);
            const currentValue = parseInt(input.value);
            
            if (currentValue < max) {
                input.value = currentValue + 1;
            } else {
                alert('Maximum stock reached: ' + max);
            }
        }

        function decreaseQuantity(productId) {
            const input = document.getElementById('quantity-' + productId);
            const currentValue = parseInt(input.value);
            
            if (currentValue > 1) {
                input.value = currentValue - 1;
            }
        }

        // Add to cart function
        function addToCart(productId) {
            const quantityInput = document.getElementById('quantity-' + productId);
            const quantity = parseInt(quantityInput.value);
            const maxStock = parseInt(quantityInput.max);

            if (isNaN(quantity) || quantity < 1) {
                alert('Please enter a valid quantity');
                return;
            }

            if (quantity > maxStock) {
                alert('Only ' + maxStock + ' items available in stock');
                quantityInput.value = maxStock;
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Adding...';
            button.disabled = true;

            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    product_id: productId, 
                    quantity: quantity 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    quantityInput.value = 1; // Reset quantity
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('‚ùå Error adding to cart. Please try again.', 'danger');
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        // Alert function
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Input validation
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const max = parseInt(this.max);
                    const value = parseInt(this.value);
                    
                    if (value < 1 || isNaN(value)) {
                        this.value = 1;
                    } else if (value > max) {
                        this.value = max;
                        alert('Maximum quantity is ' + max);
                    }
                });
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>